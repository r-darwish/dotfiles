#!/usr/bin/env bash
# hash: {{ include "run_onchange_before_bootstrap.sh.tmpl" | sha256sum }}
{{ if ne .chezmoi.os "windows" -}}
set -e

# Function to print formatted messages with green bold arrow and bold text
print_msg() {
    local green_bold='\033[1;32m'
    local bold='\033[1m'
    local reset='\033[0m'
    echo -e "${green_bold}==>${reset} ${bold}$1${reset}"
}

# Function to print sub-messages with blue arrow
print_sub_msg() {
    local blue_bold='\033[1;34m'
    local reset='\033[0m'
    echo -e "${blue_bold}==>${reset} $1"
}

print_msg "Starting bootstrap for {{ .chezmoi.os }}..."

{{ if eq .chezmoi.os "linux" -}}
# Arch Linux specific packages
if type "pacman" >/dev/null 2>&1; then
    print_msg "Installing Arch Linux packages..."
    sudo pacman -S --needed base-devel fd fzf git github-cli go htop btop lazygit neovim nodejs npm fish python ripgrep starship tmux unzip uv yazi zoxide zellij vivid ghostty-terminfo gum lsd git-delta sd

    # Install yay if not present
    if ! type "yay" >/dev/null 2>&1; then
        print_msg "Installing yay..."
        sudo pacman -S --needed --noconfirm git base-devel
        git clone https://aur.archlinux.org/yay.git /tmp/yay
        pushd /tmp/yay
        makepkg -si
        popd
        rm -rf /tmp/yay
    fi

    yay -S --needed opencode
else
    # Install Homebrew on Linux if needed
    if ! type "brew" >/dev/null 2>&1; then
        print_msg "Installing Homebrew..."
        if ! type "gcc" >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y build-essential
        fi
        if [[ ! -f /home/linuxbrew/.linuxbrew/bin/brew ]]; then
            curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh | bash
        fi
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
    fi
fi
{{ end -}}

# Install packages via Homebrew
if type "brew" >/dev/null 2>&1; then
    print_msg "Installing Homebrew packages..."
    brew install git-delta btop npm yazi starship fzf neovim zellij fd ripgrep gh lazygit gum zoxide fish lsd go node chezmoi opencode sd
    brew tap go-task/tap
    brew install go-task
fi

print_msg "Bootstrap complete!"
{{ end -}}
