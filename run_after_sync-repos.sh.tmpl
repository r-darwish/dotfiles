{{ if ne .chezmoi.os "windows" -}}
#!/usr/bin/env bash
# Sync git repositories - clone if missing, pull if exists
set -e

# Function to print formatted messages with green bold arrow and bold text
print_msg() {
    local green_bold='\033[1;32m'
    local bold='\033[1m'
    local reset='\033[0m'
    echo -e "${green_bold}==>${reset} ${bold}$1${reset}"
}

# Function to print sub-messages with blue arrow
print_sub_msg() {
    local blue_bold='\033[1;34m'
    local reset='\033[0m'
    echo -e "${blue_bold}==>${reset} $1"
}

print_msg "Syncing git repositories..."

# Helper function to clone or pull a repo
sync_repo() {
    local repo_url="$1"
    local target_dir="$2"

    if [[ -d "$target_dir/.git" ]]; then
        print_sub_msg "Updating $target_dir..."
        git -C "$target_dir" pull --ff-only
    elif [[ -d "$target_dir" ]]; then
        print_sub_msg "Directory $target_dir exists but is not a git repo, skipping..."
    else
        print_sub_msg "Cloning $repo_url to $target_dir..."
        git clone "$repo_url" "$target_dir"
    fi
}

# Sync nvim config
sync_repo "https://github.com/r-darwish/nvim" "$HOME/.config/nvim"

# Sync fish config
sync_repo "https://github.com/r-darwish/fish" "$HOME/.config/fish"

# Sync wiz-sec repos (only if wiz-sec directory exists)
if [[ -d "$HOME/wiz-sec" ]]; then
    print_msg "Syncing wiz-sec repos..."
    sync_repo "https://github.com/wiz-sec/darwish" "$HOME/wiz-sec/darwish"
    sync_repo "https://github.com/wiz-sec/dotfiles" "$HOME/wiz-sec/dotfiles"
    sync_repo "https://github.com/wiz-sec/vscode-workspace" "$HOME/wiz-sec/vscode-workspace"
fi

print_msg "Repository sync complete!"

# Generate shell configurations (needs to run after repos are synced)
print_msg "Generating shell configurations..."
gen_file="$HOME/.gen.fish"

echo "" >"$gen_file"
if type starship >/dev/null 2>&1; then
    starship init fish >>"$gen_file"
    echo "" >>"$gen_file"
fi

if type zoxide >/dev/null 2>&1; then
    zoxide init fish >>"$gen_file"
    echo "" >>"$gen_file"
fi

if type vivid >/dev/null 2>&1; then
    echo "export LS_COLORS='$(vivid generate tokyonight-night)'" >>"$gen_file"
    echo "" >>"$gen_file"
fi

if [[ -d "$HOME/wiz-sec/darwish" ]]; then
    echo "source $HOME/wiz-sec/darwish/config.fish" >>"$gen_file"
fi

print_msg "Sync complete!"

# Initialize nvim plugins (LazyVim)
if type nvim >/dev/null 2>&1; then
    print_msg "Initializing nvim plugins..."
    nvim --headless "+Lazy! sync" +qa >/dev/null 2>&1
fi
{{ end -}}
