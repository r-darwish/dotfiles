{{ if eq .chezmoi.os "windows" -}}
# Function to print formatted messages with green bold arrow and bold text
function Write-Message {
    param([string]$Message)
    Write-Host -NoNewline -ForegroundColor Green "$([char]27)[1m==>$([char]27)[0m "
    Write-Host "$([char]27)[1m$Message$([char]27)[0m"
}

# Function to print sub-messages with blue arrow
function Write-SubMessage {
    param([string]$Message)
    Write-Host -NoNewline "  "
    Write-Host -NoNewline -ForegroundColor Blue "$([char]27)[1m==>$([char]27)[0m "
    Write-Host "$Message"
}

Write-Message "Syncing git repositories..."

# Helper function to clone or pull a repo
function Sync-Repo {
    param(
        [string]$RepoUrl,
        [string]$TargetDir
    )

    if (Test-Path (Join-Path $TargetDir ".git")) {
        Write-SubMessage "Updating $TargetDir..."
        git -C $TargetDir pull --ff-only
    } elseif (Test-Path $TargetDir) {
        Write-SubMessage "Directory $TargetDir exists but is not a git repo, skipping..."
    } else {
        Write-SubMessage "Cloning $RepoUrl to $TargetDir..."
        git clone $RepoUrl $TargetDir
    }
}

# Sync nvim config
$nvimConfigDir = "$env:LOCALAPPDATA\nvim"
Sync-Repo "https://github.com/r-darwish/nvim" $nvimConfigDir

# Sync PowerShell config
$pwshProfilePath = pwsh.exe -NoProfile -Command "echo `$PROFILE"
$pwshConfigDir = Split-Path $pwshProfilePath

if (-not (Test-Path $pwshConfigDir)) {
    New-Item -ItemType Directory -Path $pwshConfigDir -Force | Out-Null
}

Sync-Repo "https://github.com/r-darwish/PowerShell" $pwshConfigDir

Write-Message "Repository sync complete!"

# Initialize nvim plugins (LazyVim)
if (Get-Command nvim -ErrorAction SilentlyContinue) {
    Write-Message "Initializing nvim plugins..."
    nvim --headless "+Lazy! sync" +qa >$null 2>&1
}
{{ end -}}
